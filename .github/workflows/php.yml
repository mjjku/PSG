name: "Proxy Subscription Generator (PSG)"

on:
  workflow_dispatch:
  schedule:
    - cron: '0 * * * *' # Run every hour exactly

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: true

permissions:
  contents: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          extensions: mbstring, curl, sockets
          tools: composer

      - name: Setup Cloudflare WARP for IP Masking
        uses: sebst/actions-warp@v1
        with:
          tos: YES

      - name: Verify WARP Connection
        run: |
          curl https://www.cloudflare.com/cdn-cgi/trace/ | grep warp=on || { echo "‚ùå WARP connection failed"; exit 1; }

      - name: Patch precheck.php for PHP 8 compatibility
        run: |
          if [ -f "scripts/precheck.php" ]; then
            sed -i 's/stream_set_blocking(\([^,]*\), *0)/stream_set_blocking(\1, false)/g' scripts/precheck.php
            sed -i 's/stream_set_blocking(\([^,]*\), *1)/stream_set_blocking(\1, true)/g' scripts/precheck.php
            echo "‚úÖ Patch applied to scripts/precheck.php"
          else
            echo "‚ÑπÔ∏è scripts/precheck.php not found, skipping patch."
          fi

      - name: Generate Full Subscriptions
        run: |
          set -e
          echo "--- Starting Full PSG Generation ---"
          php channelsAssets.php || { echo "‚ùå channelsAssets.php failed"; exit 1; }
          php get.php || { echo "‚ùå get.php failed"; exit 1; }
          php duplicate.php || { echo "‚ùå duplicate.php failed"; exit 1; }
          php sort.php || { echo "‚ùå sort.php failed"; exit 1; }
          php toSingbox.php || { echo "‚ùå toSingbox.php failed"; exit 1; }
          php toClashSurfboard.php || { echo "‚ùå toClashSurfboard.php failed"; exit 1; }
          php hiddifyWarp.php || { echo "‚ùå hiddifyWarp.php failed"; exit 1; }
          echo "--- ‚úÖ Full Generation Complete ---"

      - name: Generate Lite Subscriptions
        run: |
          set -e
          echo "--- Starting Lite PSG Generation ---"
          cd lite
          php channelsAssets.php || { echo "‚ùå channelsAssets.php failed"; exit 1; }
          php get.php || { echo "‚ùå get.php failed"; exit 1; }
          php duplicate.php || { echo "‚ùå duplicate.php failed"; exit 1; }
          php sort.php || { echo "‚ùå sort.php failed"; exit 1; }
          php toSingbox.php || { echo "‚ùå toSingbox.php failed"; exit 1; }
          php toClashSurfboard.php || { echo "‚ùå toClashSurfboard.php failed"; exit 1; }
          echo "--- ‚úÖ Lite Generation Complete ---"

      - name: Generate HTML Index Page
        run: |
          set -e
          echo "--- Generating HTML index page ---"
          php generate_page.php || { echo "‚ùå generate_page.php failed"; exit 1; }
          echo "--- ‚úÖ HTML index page generated ---"

      - name: Commit and Push Files
        env:
          TOKEN: ${{ secrets.PAT_TOKEN || github.token }}
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add -A
          git commit -m "üöÄ Subscription Update | $(TZ='Asia/Tehran' date '+%Y-%m-%d %H:%M:%S')" || echo "‚ÑπÔ∏è No changes to commit."
          git push https://x-access-token:${TOKEN}@github.com/${{ github.repository }} HEAD:${GITHUB_REF}
